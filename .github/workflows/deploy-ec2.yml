name: Deploy to AWS EC2

on:
  push:
    branches:
      - production
  workflow_dispatch:  # Allows manual trigger

jobs:
  build-and-deploy:
    name: Build and Deploy Backend to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Backend/package-lock.json
      
      - name: Install dependencies
        working-directory: Backend
        run: |
          echo "üì¶ Installing dependencies..."
          npm ci
      
      - name: Build TypeScript
        working-directory: Backend
        run: |
          echo "üèóÔ∏è Building TypeScript..."
          npm run build
          echo "‚úÖ Build complete!"
          echo "üìÅ Contents of dist folder:"
          ls -la dist/
      
      - name: Create deployment package
        working-directory: Backend
        run: |
          echo "üì¶ Creating deployment package..."
          tar -czf dist.tar.gz dist/
          echo "‚úÖ Package created:"
          ls -lh dist.tar.gz
      
      - name: Verify dist.tar.gz exists
        working-directory: Backend
        run: |
          echo "üîç Verifying dist.tar.gz exists before upload..."
          if [ ! -f dist.tar.gz ]; then
            echo "‚ùå ERROR: dist.tar.gz not found in Backend directory!"
            exit 1
          fi
          echo "‚úÖ dist.tar.gz found:"
          ls -lh dist.tar.gz
      
      - name: Ensure target directory exists on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üìÅ Ensuring target directory exists..."
            mkdir -p /home/ubuntu/Audio-extractor-Chrome-Extension/Backend
            echo "‚úÖ Directory ready"
      
      - name: Verify file path for upload
        run: |
          echo "üîç Verifying file exists at workspace root level..."
          ls -lh Backend/dist.tar.gz || echo "File not found at Backend/dist.tar.gz"
          pwd
          echo "üìÅ Workspace contents:"
          ls -la | head -10
      
      - name: Upload dist.tar.gz to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "Backend/dist.tar.gz"
          target: "/home/ubuntu/Audio-extractor-Chrome-Extension/Backend/"
          strip_components: 1
          debug: true
          overwrite: true
          rm: false
        continue-on-error: false
      
      - name: Verify upload on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üîç Verifying dist.tar.gz was uploaded successfully..."
            cd /home/ubuntu/Audio-extractor-Chrome-Extension/Backend || exit 1
            echo "üìÅ Current directory:"
            pwd
            echo "üìÅ Directory contents:"
            ls -la | head -20
            
            # Check both possible locations
            if [ -f dist.tar.gz ]; then
              echo "‚úÖ dist.tar.gz found in current directory:"
              ls -lh dist.tar.gz
              echo "üîç Verifying file integrity..."
              if [ -s dist.tar.gz ]; then
                echo "‚úÖ File is not empty, size check passed"
              else
                echo "‚ùå ERROR: File is empty!"
                exit 1
              fi
            elif [ -f Backend/dist.tar.gz ]; then
              echo "‚úÖ dist.tar.gz found in Backend/ subdirectory (will be moved during deployment):"
              ls -lh Backend/dist.tar.gz
              echo "üîç Verifying file integrity..."
              if [ -s Backend/dist.tar.gz ]; then
                echo "‚úÖ File is not empty, size check passed"
                echo "‚ÑπÔ∏è Note: File will be moved to current directory during deployment"
              else
                echo "‚ùå ERROR: File is empty!"
                exit 1
              fi
            else
              echo "‚ùå ERROR: dist.tar.gz not found on EC2 after upload!"
              echo "üìÅ Full directory contents:"
              ls -la
              if [ -d Backend ]; then
                echo "üìÅ Backend subdirectory contents:"
                ls -la Backend/ | head -10
              fi
              echo "üîç Searching for dist.tar.gz..."
              find /home/ubuntu -name "dist.tar.gz" -type f 2>/dev/null | head -10
              exit 1
            fi
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "üöÄ Starting deployment..."
            
            # Navigate to backend directory
            cd /home/ubuntu/Audio-extractor-Chrome-Extension/Backend || { echo "‚ùå Backend directory not found!"; exit 1; }
            
            echo "üìÅ Current working directory:"
            pwd
            
            # IMPORTANT: Extract dist.tar.gz FIRST before any git operations
            # (git clean might remove it if we do git operations first)
            echo "üì¶ Looking for dist.tar.gz..."
            
            # Check multiple possible locations (SCP might extract to Backend/Backend/)
            DIST_TAR=""
            if [ -f dist.tar.gz ]; then
              DIST_TAR="dist.tar.gz"
              echo "‚úÖ Found dist.tar.gz in current directory"
            elif [ -f Backend/dist.tar.gz ]; then
              echo "‚úÖ Found dist.tar.gz in Backend/ subdirectory, moving to current directory..."
              mv Backend/dist.tar.gz dist.tar.gz
              DIST_TAR="dist.tar.gz"
              echo "‚úÖ File moved successfully"
            elif [ -f ./dist.tar.gz ]; then
              DIST_TAR="./dist.tar.gz"
              echo "‚úÖ Found dist.tar.gz with ./ prefix"
            else
              echo "‚ùå ERROR: dist.tar.gz not found in expected location!"
              echo "üìÅ Current directory contents:"
              ls -la
              if [ -d Backend ]; then
                echo "üìÅ Backend subdirectory contents:"
                ls -la Backend/ | head -10
              fi
              echo "üîç Searching for dist.tar.gz..."
              find /home/ubuntu -name "dist.tar.gz" -type f 2>/dev/null | head -5 || echo "No dist.tar.gz found anywhere"
              exit 1
            fi
            
            if [ -n "$DIST_TAR" ]; then
              echo "‚úÖ Found dist.tar.gz, extracting..."
              rm -rf dist/  # Remove old dist if exists
              tar -xzf "$DIST_TAR"
              echo "‚úÖ Dist folder extracted:"
              ls -la dist/
              
              # Verify extraction was successful
              if [ ! -d dist ] || [ ! -f dist/server.js ]; then
                echo "‚ùå ERROR: dist folder extraction failed or server.js not found!"
                exit 1
              fi
              
              echo "üîç Verifying /auth/latest endpoint after extraction..."
              if grep -q "auth/latest" dist/server.js; then
                echo "‚úÖ /auth/latest endpoint verified in extracted dist/server.js"
              else
                echo "‚ö†Ô∏è WARNING: /auth/latest endpoint not found, but continuing..."
              fi
            fi
            
            echo "üì• Pulling latest code from production branch..."
            git fetch origin
            git checkout production
            # Handle untracked files that might conflict (but preserve dist.tar.gz and dist/)
            git clean -fd --exclude=dist.tar.gz --exclude=dist/ || true
            git pull origin production || {
              echo "‚ö†Ô∏è Git pull had conflicts, stashing local changes..."
              git stash || true
              git pull origin production || true
            }
            
            # Clean up dist.tar.gz after git operations
            rm -f dist.tar.gz
            
            echo "üîß Setting up Dockerfile..."
            if [ -f Dockerfile.fast ]; then
              cp Dockerfile.fast Dockerfile
              echo "‚úÖ Using Dockerfile.fast"
            else
              echo "‚ö†Ô∏è Dockerfile.fast not found, using existing Dockerfile"
            fi
            
            echo "üîç Verifying dist folder is ready..."
            if [ ! -d dist ] || [ ! -f dist/server.js ]; then
              echo "‚ùå ERROR: dist folder is missing or incomplete!"
              echo "üìÅ Current directory contents:"
              ls -la
              exit 1
            fi
            
            # Check dist folder modification time (should be recent)
            DIST_AGE=$(find dist/server.js -mmin +60 2>/dev/null && echo "old" || echo "recent")
            if [ "$DIST_AGE" = "old" ]; then
              echo "‚ö†Ô∏è WARNING: dist/server.js is older than 60 minutes. This might be old code!"
            else
              echo "‚úÖ dist/server.js is recent"
            fi
            
            echo "üíæ Checking disk space..."
            df -h
            # Get available space in MB (more reliable than GB parsing)
            AVAILABLE_MB=$(df -m / | tail -1 | awk '{print $4}')
            echo "Available space: ${AVAILABLE_MB}MB"
            
            # Check if we have less than 2000MB (2GB) free
            if [ "$AVAILABLE_MB" -lt 2000 ]; then
              echo "‚ö†Ô∏è Low disk space detected (< 2GB), cleaning up..."
              
              echo "üõë Stopping existing containers..."
              docker-compose -f docker-compose.prod.yml down || true
              
              echo "üßπ Aggressive Docker cleanup..."
              docker system prune -af --volumes || true
              docker builder prune -af || true
              
              # Remove unused images
              docker image prune -af || true
              
              # Remove old dist folders if they exist
              find . -name "node_modules" -type d -exec rm -rf {} + 2>/dev/null || true
              
              echo "üíæ Disk space after cleanup:"
              df -h
            else
              echo "‚úÖ Sufficient disk space available"
            fi
            
            echo "üõë Stopping existing containers..."
            docker-compose -f docker-compose.prod.yml down || true
            
            echo "üóëÔ∏è Removing old backend image to force rebuild..."
            docker rmi backend-backend 2>/dev/null || echo "Image not found (will be built fresh)"
            docker rmi $(docker images -q backend-backend) 2>/dev/null || true
            
            echo "üßπ Cleaning up Docker (free space)..."
            docker system prune -f || true
            
            echo "üèóÔ∏è Building Docker image (this will use the new dist folder)..."
            if ! docker-compose -f docker-compose.prod.yml build --no-cache; then
              echo "‚ùå Docker build failed! Attempting cleanup and retry..."
              
              # More aggressive cleanup
              docker system prune -af || true
              docker builder prune -af || true
              
              # Check disk space again
              echo "üíæ Disk space after cleanup:"
              df -h
              
              # Retry build
              echo "üîÑ Retrying Docker build..."
              if ! docker-compose -f docker-compose.prod.yml build --no-cache; then
                echo "‚ùå ERROR: Docker build failed after cleanup. Deployment cannot continue."
                exit 1
              fi
            fi
            
            echo "‚úÖ Docker build completed successfully"
            
            echo "üöÄ Starting containers..."
            docker-compose -f docker-compose.prod.yml up -d
            
            echo "‚è≥ Waiting for container to be healthy..."
            sleep 10
            
            echo "üîç Verifying deployed code matches build..."
            # Check if the new code is in the container
            if docker exec audio-extractor-backend test -f /app/dist/server.js; then
              echo "‚úÖ Container has server.js"
              
              # Verify the new endpoints exist
              if docker exec audio-extractor-backend grep -q "auth/latest" /app/dist/server.js; then
                echo "‚úÖ /auth/latest endpoint found in container"
              else
                echo "‚ö†Ô∏è WARNING: /auth/latest endpoint NOT found in container!"
              fi
              
              # Check if userinfo scopes are in the code
              if docker exec audio-extractor-backend grep -q "userinfo.email" /app/dist/driveService.js 2>/dev/null; then
                echo "‚úÖ Userinfo scopes found in container"
              else
                echo "‚ö†Ô∏è WARNING: Userinfo scopes NOT found in container!"
              fi
              
              # Get file modification time to verify it's recent
              CONTAINER_FILE_TIME=$(docker exec audio-extractor-backend stat -c %Y /app/dist/server.js 2>/dev/null || echo "0")
              LOCAL_FILE_TIME=$(stat -c %Y dist/server.js 2>/dev/null || echo "0")
              
              if [ "$CONTAINER_FILE_TIME" != "0" ] && [ "$LOCAL_FILE_TIME" != "0" ]; then
                TIME_DIFF=$((CONTAINER_FILE_TIME - LOCAL_FILE_TIME))
                if [ $TIME_DIFF -lt 300 ]; then
                  echo "‚úÖ Container file is recent (within 5 minutes of local file)"
                else
                  echo "‚ö†Ô∏è WARNING: Container file timestamp differs significantly from local file"
                fi
              fi
            else
              echo "‚ùå ERROR: Container does not have server.js file!"
            fi
            
            echo "üßπ Cleaning up unused Docker images..."
            docker image prune -f || true
            
            echo "üìä Container status:"
            docker-compose -f docker-compose.prod.yml ps
            
            echo "üìã Recent logs:"
            docker-compose -f docker-compose.prod.yml logs --tail=30
            
            echo "üè• Health check..."
            curl -f http://localhost:5000/drive/status || echo "‚ö†Ô∏è Health check failed, but deployment completed"
            
            echo "‚úÖ Deployment complete!"

