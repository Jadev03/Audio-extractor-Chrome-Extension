name: Deploy to AWS EC2

on:
  push:
    branches:
      - production
  workflow_dispatch:  # Allows manual trigger

jobs:
  build-and-deploy:
    name: Build and Deploy Backend to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Backend/package-lock.json
      
      - name: Install dependencies
        working-directory: Backend
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
      
      - name: Build TypeScript
        working-directory: Backend
        run: |
          echo "ğŸ—ï¸ Building TypeScript..."
          npm run build
          echo "âœ… Build complete!"
          echo "ğŸ“ Contents of dist folder:"
          ls -la dist/
      
      - name: Create deployment package
        working-directory: Backend
        run: |
          echo "ğŸ“¦ Creating deployment package..."
          tar -czf dist.tar.gz dist/
          echo "âœ… Package created:"
          ls -lh dist.tar.gz
      
      - name: Upload dist to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "Backend/dist.tar.gz"
          target: "/home/ubuntu/Audio-extractor-Chrome-Extension/Backend/"
          strip_components: 0
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # Navigate to backend directory
            cd /home/ubuntu/Audio-extractor-Chrome-Extension/Backend || { echo "âŒ Backend directory not found!"; exit 1; }
            
            # IMPORTANT: Extract dist.tar.gz FIRST before any git operations
            # (git clean might remove it if we do git operations first)
            echo "ğŸ“¦ Extracting dist folder (BEFORE git operations)..."
            echo "ğŸ“ Checking for dist.tar.gz in current directory:"
            pwd
            ls -la dist.tar.gz 2>/dev/null || echo "âš ï¸ dist.tar.gz not found yet"
            
            if [ -f dist.tar.gz ]; then
              echo "âœ… Found dist.tar.gz, extracting..."
              rm -rf dist/  # Remove old dist if exists
              tar -xzf dist.tar.gz
              # Keep dist.tar.gz for now (don't delete yet)
              echo "âœ… Dist folder extracted:"
              ls -la dist/
              echo "ğŸ” Verifying /auth/latest endpoint after extraction..."
              if grep -q "auth/latest" dist/server.js; then
                echo "âœ… /auth/latest endpoint verified in extracted dist/server.js"
              else
                echo "âŒ ERROR: /auth/latest endpoint NOT found after extraction!"
                exit 1
              fi
            else
              echo "âŒ ERROR: dist.tar.gz not found! Deployment cannot continue."
              echo "ğŸ“ Current directory contents:"
              ls -la
              exit 1
            fi
            
            echo "ğŸ“¥ Pulling latest code from production branch..."
            git fetch origin
            git checkout production
            # Handle untracked files that might conflict (but preserve dist.tar.gz and dist/)
            git clean -fd --exclude=dist.tar.gz --exclude=dist/ || true
            git pull origin production || {
              echo "âš ï¸ Git pull had conflicts, stashing local changes..."
              git stash || true
              git pull origin production || true
            }
            
            # Clean up dist.tar.gz after git operations
            rm -f dist.tar.gz
            
            echo "ğŸ”§ Setting up Dockerfile..."
            if [ -f Dockerfile.fast ]; then
              cp Dockerfile.fast Dockerfile
              echo "âœ… Using Dockerfile.fast"
            else
              echo "âš ï¸ Dockerfile.fast not found, using existing Dockerfile"
            fi
            
            echo "ğŸ›‘ Stopping existing containers..."
            docker-compose -f docker-compose.prod.yml down || true
            
            echo "ğŸ§¹ Cleaning up Docker (free space)..."
            docker system prune -f || true
            
            echo "ğŸ—ï¸ Building Docker image..."
            docker-compose -f docker-compose.prod.yml build --no-cache
            
            echo "ğŸš€ Starting containers..."
            docker-compose -f docker-compose.prod.yml up -d
            
            echo "â³ Waiting for container to be healthy..."
            sleep 10
            
            echo "ğŸ§¹ Cleaning up unused Docker images..."
            docker image prune -f || true
            
            echo "ğŸ“Š Container status:"
            docker-compose -f docker-compose.prod.yml ps
            
            echo "ğŸ“‹ Recent logs:"
            docker-compose -f docker-compose.prod.yml logs --tail=30
            
            echo "ğŸ¥ Health check..."
            curl -f http://localhost:5000/drive/status || echo "âš ï¸ Health check failed, but deployment completed"
            
            echo "âœ… Deployment complete!"

