name: Deploy to AWS EC2

on:
  push:
    branches:
      - production
  workflow_dispatch:  # Allows manual trigger

jobs:
  build-and-deploy:
    name: Build and Deploy Backend to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: Backend/package-lock.json
      
      - name: Install dependencies
        working-directory: Backend
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
      
      - name: Build TypeScript
        working-directory: Backend
        run: |
          echo "ğŸ—ï¸ Building TypeScript..."
          npm run build
          echo "âœ… Build complete!"
          echo "ğŸ“ Contents of dist folder:"
          ls -la dist/
      
      - name: Create deployment package
        working-directory: Backend
        run: |
          echo "ğŸ“¦ Creating deployment package..."
          tar -czf dist.tar.gz dist/
          echo "âœ… Package created:"
          ls -lh dist.tar.gz
      
      - name: Verify dist.tar.gz exists
        working-directory: Backend
        run: |
          echo "ğŸ” Verifying dist.tar.gz exists before upload..."
          if [ ! -f dist.tar.gz ]; then
            echo "âŒ ERROR: dist.tar.gz not found in Backend directory!"
            exit 1
          fi
          echo "âœ… dist.tar.gz found:"
          ls -lh dist.tar.gz
      
      - name: Ensure target directory exists on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ“ Ensuring target directory exists..."
            mkdir -p /home/ubuntu/Audio-extractor-Chrome-Extension/Backend
            echo "âœ… Directory ready for upload"
      
      - name: Upload dist to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "Backend/dist.tar.gz"
          target: "/home/ubuntu/Audio-extractor-Chrome-Extension/Backend/"
          strip_components: 0
          debug: true
          overwrite: true
      
      - name: Verify upload on EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ” Verifying dist.tar.gz was uploaded successfully..."
            cd /home/ubuntu/Audio-extractor-Chrome-Extension/Backend || exit 1
            if [ -f dist.tar.gz ]; then
              echo "âœ… dist.tar.gz found on EC2:"
              ls -lh dist.tar.gz
            else
              echo "âŒ ERROR: dist.tar.gz not found on EC2 after upload!"
              echo "ğŸ“ Current directory contents:"
              ls -la
              exit 1
            fi
      
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # Navigate to backend directory
            cd /home/ubuntu/Audio-extractor-Chrome-Extension/Backend || { echo "âŒ Backend directory not found!"; exit 1; }
            
            echo "ğŸ“ Current working directory:"
            pwd
            
            # IMPORTANT: Extract dist.tar.gz FIRST before any git operations
            # (git clean might remove it if we do git operations first)
            echo "ğŸ“¦ Looking for dist.tar.gz..."
            
            # Check multiple possible locations
            DIST_TAR=""
            if [ -f dist.tar.gz ]; then
              DIST_TAR="dist.tar.gz"
              echo "âœ… Found dist.tar.gz in current directory"
            elif [ -f ./dist.tar.gz ]; then
              DIST_TAR="./dist.tar.gz"
              echo "âœ… Found dist.tar.gz with ./ prefix"
            else
              echo "âŒ ERROR: dist.tar.gz not found in expected location!"
              echo "ğŸ“ Current directory contents:"
              ls -la
              echo "ğŸ” Searching for dist.tar.gz in parent directories..."
              find /home/ubuntu -name "dist.tar.gz" -type f 2>/dev/null | head -5 || echo "No dist.tar.gz found anywhere"
              exit 1
            fi
            
            if [ -n "$DIST_TAR" ]; then
              echo "âœ… Found dist.tar.gz, extracting..."
              rm -rf dist/  # Remove old dist if exists
              tar -xzf "$DIST_TAR"
              echo "âœ… Dist folder extracted:"
              ls -la dist/
              
              # Verify extraction was successful
              if [ ! -d dist ] || [ ! -f dist/server.js ]; then
                echo "âŒ ERROR: dist folder extraction failed or server.js not found!"
                exit 1
              fi
              
              echo "ğŸ” Verifying /auth/latest endpoint after extraction..."
              if grep -q "auth/latest" dist/server.js; then
                echo "âœ… /auth/latest endpoint verified in extracted dist/server.js"
              else
                echo "âš ï¸ WARNING: /auth/latest endpoint not found, but continuing..."
              fi
            fi
            
            echo "ğŸ“¥ Pulling latest code from production branch..."
            git fetch origin
            git checkout production
            # Handle untracked files that might conflict (but preserve dist.tar.gz and dist/)
            git clean -fd --exclude=dist.tar.gz --exclude=dist/ || true
            git pull origin production || {
              echo "âš ï¸ Git pull had conflicts, stashing local changes..."
              git stash || true
              git pull origin production || true
            }
            
            # Clean up dist.tar.gz after git operations
            rm -f dist.tar.gz
            
            echo "ğŸ”§ Setting up Dockerfile..."
            if [ -f Dockerfile.fast ]; then
              cp Dockerfile.fast Dockerfile
              echo "âœ… Using Dockerfile.fast"
            else
              echo "âš ï¸ Dockerfile.fast not found, using existing Dockerfile"
            fi
            
            echo "ğŸ›‘ Stopping existing containers..."
            docker-compose -f docker-compose.prod.yml down || true
            
            echo "ğŸ§¹ Cleaning up Docker (free space)..."
            docker system prune -f || true
            
            echo "ğŸ—ï¸ Building Docker image..."
            docker-compose -f docker-compose.prod.yml build --no-cache
            
            echo "ğŸš€ Starting containers..."
            docker-compose -f docker-compose.prod.yml up -d
            
            echo "â³ Waiting for container to be healthy..."
            sleep 10
            
            echo "ğŸ§¹ Cleaning up unused Docker images..."
            docker image prune -f || true
            
            echo "ğŸ“Š Container status:"
            docker-compose -f docker-compose.prod.yml ps
            
            echo "ğŸ“‹ Recent logs:"
            docker-compose -f docker-compose.prod.yml logs --tail=30
            
            echo "ğŸ¥ Health check..."
            curl -f http://localhost:5000/drive/status || echo "âš ï¸ Health check failed, but deployment completed"
            
            echo "âœ… Deployment complete!"

